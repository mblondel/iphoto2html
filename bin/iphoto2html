#!/usr/bin/env python

import os
import urllib

from iphoto2html import get_data_dir
from iphoto2html.iphotodata import get_iphoto_data


def group(it, size):
    gr = []
    for ele in it:
        gr.append(ele)
        if len(gr) == size:
            yield gr
            gr = []
    if len(gr) != 0:
        yield gr


def gen_album_thumbnail(data, out, albumid):
    album = data.albums[albumid]
    images = [img for img in album.images if not img.ishidden()]
    albumid = album.albumid.encode("utf8")
    name = album.name.encode("utf8")

    if len(images) > 0:
        img = images[0]
        thumbpath = img.thumbpath.encode("utf8")
        thumbpath = "../" + thumbpath[thumbpath.index("Thumbnails"):]
        thumbpath = urllib.quote(thumbpath)
        out.write("%s<br /><a href='album_%s.html'><img src='%s' "
                  "class='thumbnail'></a>\n" % (name, albumid, thumbpath))
    else:
        out.write("<a href='album_%s.html'>%s</a>\n" % \
                  (albumid, name))


def gen_album(data, outdir, albumid, opts):
    out = os.path.join(outdir, "album_%s.html" % albumid.encode("utf8"))
    out = file(out, "w")

    album = data.albums[albumid]
    name = album.name.encode("utf8")

    out.write("""
<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>iPhoto gallery</title>
        <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
        <link rel="stylesheet" href="style.css" type="text/css" media="screen">
    </head>
    <body>
        <h2>%s</h2>
        <table>
""" % name)

    images = [img for img in album.images if not img.ishidden()]
    images.sort(lambda x,y: cmp(x.date, y.date))

    for line in group(images, 3):
        out.write("<tr>\n")

        for img in line:
            thumbpath = img.thumbpath.encode("utf8")
            thumbpath = "../" + thumbpath[thumbpath.index("Thumbnails"):]
            thumbpath = urllib.quote(thumbpath)

            imgpath = img.getimagepath().encode("utf8")
            try:
                imgpath = "../" + imgpath[imgpath.index("Masters"):]
            except:
                imgpath = "../" + imgpath[imgpath.index("Previews"):]
            imgpath = urllib.quote(imgpath)


            if opts.imagephp and not img.ismovie():
                imgpath = "image.php?filename=" + imgpath

            caption = ""

            if img.ismovie():
                caption += "&nbsp;<img src='camera-video-small.png' />"

            out.write("<td>%s<br/><a href='%s'><img src='%s' class='thumbnail' /></a></td>\n" % \
                      (caption, imgpath, thumbpath))

        out.write("</tr>\n")

    out.write("""
        </table>
    </body>
</html>
""")


def gen_index(data, out, albumtype):
    albums = [a for a in data.albums.values() if a.albumtype == albumtype]
    albums = [a for a in albums if not a.ishidden()]
    albums.sort(lambda x,y: cmp(x.date, y.date), reverse=True)

    out.write("<table>\n")

    for line in group(albums, 3):
        out.write("<tr>\n")

        for album in line:
            out.write("<td>")
            gen_album_thumbnail(data, out, album.albumid)
            out.write("</td>")

        out.write("</tr>\n")

    out.write("</table>\n")


def gen_all(data, outdir, opts):
    out = os.path.join(outdir, "index.html")
    out = file(out, "w")
    out.write("""
<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>iPhoto gallery</title>
        <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
        <link rel="stylesheet" href="style.css" type="text/css" media="screen">
    </head>
    <body>
""")

    out.write("<h2>Albums</h2>\n")
    gen_index(data, out, "Regular")

    out.write("<h2>Events</h2>\n")
    gen_index(data, out, "Event")


    for albumid, album in data.albums.items():
        gen_album(data, outdir, album.albumid, opts)

        #print album.albumid
        #print album.albumtype
        #print album.parent.name
        #print album.parent.albumid

    out.write("""
    </body>
</html>
""")


if __name__ == '__main__':
    import shutil
    from optparse import OptionParser
    import glob

    op = OptionParser()
    op.add_option("--imagephp", action="store_true", dest="imagephp")
    (opts, args) = op.parse_args()

    photolib = os.path.join(args[0], "AlbumData.xml")
    out = os.path.join(args[0], "html")

    data = get_iphoto_data(photolib)

    if not os.path.exists(out):
        os.makedirs(out)

    gen_all(data, out, opts)

    datadir = get_data_dir()

    shutil.copyfile(os.path.join(datadir, "style.css"),
                    os.path.join(out, "style.css"))

    for png in glob.glob(os.path.join(datadir, "*.png")):
        png_base = os.path.basename(png)
        shutil.copyfile(png, os.path.join(out, png_base))

    if opts.imagephp:
        shutil.copyfile(os.path.join(datadir, "image.php"),
                        os.path.join(out, "image.php"))
